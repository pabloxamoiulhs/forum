<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Fix Stegas Chat</title>
<style>
  body { margin:0; font-family: Arial; background: white; display:flex; flex-direction:column; align-items:center;}
  #chat { width: 500px; max-width: 90%; height: 400px; border: 1px solid #ccc; overflow-y: auto; padding: 10px; margin-top: 20px; }
  #messageInput { width: 400px; padding: 10px; margin-top: 10px; }
  #sendBtn { padding: 10px 20px; margin-left: 10px; }
  .message { display: flex; align-items: center; margin: 5px 0; }
  .message img { width:30px; height:30px; border-radius:50%; margin-right:10px; }
  .admin-btn { color:red; margin-left:5px; cursor:pointer; }
  .ban-btn { color:orange; margin-left:5px; cursor:pointer; }
</style>
</head>
<body>
<h1>General Channel</h1>

<div id="chat"></div>

<div>
  <input type="text" id="messageInput" placeholder="Type a message">
  <button id="sendBtn">Send</button>
</div>

<script src="https://www.gstatic.com/firebasejs/10.6.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.6.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.6.0/firebase-firestore-compat.js"></script>

<script>
const firebaseConfig = {
  apiKey: "AIzaSyAWLLh2eWpATxKPQpgyTAf-dufkB8NRh6E",
  authDomain: "forum-11d1d.firebaseapp.com",
  projectId: "forum-11d1d",
  storageBucket: "forum-11d1d.firebasestorage.app",
  messagingSenderId: "447915576463",
  appId: "1:447915576463:web:3a07d16e1bc9b73063b4fa"
};

firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db = firebase.firestore();

let currentUser;
const adminEmail = "YOUR_ADMIN_EMAIL_HERE"; // replace with your email

auth.onAuthStateChanged(user => {
  if(!user) {
    window.location.href = 'index.html';
  } else {
    currentUser = user;
    loadMessages();
  }
});

document.getElementById('sendBtn').addEventListener('click', () => {
  const text = document.getElementById('messageInput').value.trim();
  if(!text) return;

  const now = Date.now();
  if(currentUser.lastMessage && now - currentUser.lastMessage < 2000) return alert('Slow down!');
  currentUser.lastMessage = now;

  db.collection('channels').doc('general').collection('messages').add({
    user: currentUser.email,
    text: text,
    timestamp: now
  });
  document.getElementById('messageInput').value = '';
});

function loadMessages() {
  const chatDiv = document.getElementById('chat');
  db.collection('channels').doc('general').collection('messages')
    .orderBy('timestamp')
    .onSnapshot(snapshot => {
      chatDiv.innerHTML = '';
      snapshot.forEach(async doc => {
        const msg = doc.data();
        const div = document.createElement('div');
        div.classList.add('message');

        // Default avatar
        let photoURL = "https://i.imgur.com/pi2JlKR.png";

        // Get user's photoURL
        const userQuery = await db.collection('users').where('email','==',msg.user).get();
        if(!userQuery.empty){
          photoURL = userQuery.docs[0].data().photoURL || photoURL;
        }

        div.innerHTML = `<img src="${photoURL}"><strong>${msg.user}</strong>: ${msg.text}`;

        // Admin buttons
        if(currentUser.email === adminEmail){
          const delBtn = document.createElement('span');
          delBtn.textContent = 'Delete';
          delBtn.classList.add('admin-btn');
          delBtn.onclick = () => doc.ref.delete();
          div.appendChild(delBtn);

          const banBtn = document.createElement('span');
          banBtn.textContent = 'Ban';
          banBtn.classList.add('ban-btn');
          banBtn.onclick = () => {
            db.collection('users').where('email','==',msg.user).get().then(qs=>{
              qs.forEach(u => u.ref.update({banned:true}));
            });
          };
          div.appendChild(banBtn);
        }

        chatDiv.appendChild(div);
        chatDiv.scrollTop = chatDiv.scrollHeight;
      });
    });
}
</script>
</body>
</html>
